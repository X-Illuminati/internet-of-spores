[{"id":"fb425031.4cd18","type":"tab","label":"Sensor Test","disabled":false,"info":""},{"id":"8e97fd4.b42f18","type":"tab","label":"update firmware","disabled":false,"info":""},{"id":"7b8a611f.628c2","type":"tab","label":"handle sensor readings","disabled":false,"info":""},{"id":"84d338b0.987b","type":"subflow","name":"Subflow 1","info":"","in":[],"out":[]},{"id":"70d4d9b.8d043a8","type":"subflow","name":"Subflow 2","info":"","in":[{"x":50,"y":30,"wires":[]}],"out":[{"x":215,"y":30,"wires":[]},{"x":270,"y":30,"wires":[]}],"status":{"x":140,"y":120,"wires":[{"id":"70d4d9b.8d043a8","port":0}]}},{"id":"fa189a34.f2435","type":"tcp in","z":"fb425031.4cd18","name":"","server":"server","host":"","port":"2880","datamode":"stream","datatype":"utf8","newline":"","topic":"","base64":false,"x":100,"y":100,"wires":[["c1f9de2c.2b2158","952c23eb.d6d298"]]},{"id":"7e4f34ea.f9f65c","type":"json","z":"fb425031.4cd18","name":"","property":"payload","action":"","pretty":false,"x":330,"y":180,"wires":[["5bf6abe.5402dd4","6362a80a.76498"]]},{"id":"5bf6abe.5402dd4","type":"debug","z":"fb425031.4cd18","name":"debug json","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":470,"y":140,"wires":[]},{"id":"c1f9de2c.2b2158","type":"debug","z":"fb425031.4cd18","name":"debug tcp","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":240,"y":60,"wires":[]},{"id":"952c23eb.d6d298","type":"join","z":"fb425031.4cd18","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"","joinerType":"str","accumulate":false,"timeout":"0.2","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":290,"y":100,"wires":[["7e4f34ea.f9f65c","251da0fd.a4dde8"]]},{"id":"251da0fd.a4dde8","type":"debug","z":"fb425031.4cd18","name":"debug join","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":430,"y":60,"wires":[]},{"id":"cdc4e939.2808b8","type":"switch","z":"fb425031.4cd18","name":"","property":"payload.command","propertyType":"msg","rules":[{"t":"eq","v":"update","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":470,"y":340,"wires":[["fca8a92b.2eccc"],["96ec5b54.f3e4"]]},{"id":"c054a5c6.afd4c8","type":"function","z":"8e97fd4.b42f18","name":"parse update","func":"var filename = msg.payload.arg;\n\nmsg.filename = \"__invalid__\";\n\nfor (var i = 0; i < msg.firmware_dir.length; i++)\n{\n    if (msg.firmware_dir[i].toLowerCase().search(filename.toLowerCase()) >= 0)\n        if (msg.firmware_dir[i].toLowerCase().search(msg.firmware.toLowerCase()) == -1)\n            msg.filename = msg.firmware_dir[i];\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":140,"wires":[["83c3589e.3291e","150c8c6b.10168c"]]},{"id":"83c3589e.3291e","type":"file in","z":"8e97fd4.b42f18","name":"","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":450,"y":220,"wires":[["b7ec7007.a70f48"]]},{"id":"fca8a92b.2eccc","type":"link out","z":"fb425031.4cd18","name":"handle update","links":["41799362.815f0c"],"x":575,"y":320,"wires":[]},{"id":"41799362.815f0c","type":"link in","z":"8e97fd4.b42f18","name":"handle update","links":["fca8a92b.2eccc"],"x":175,"y":60,"wires":[["7dcb104b.e3f668"]]},{"id":"960d055.d13aa78","type":"link in","z":"7b8a611f.628c2","name":"handle sensor readings","links":["96ec5b54.f3e4"],"x":175,"y":60,"wires":[["e7a25533.761ed"]]},{"id":"cb023030.4fbfb8","type":"tcp out","z":"7b8a611f.628c2","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"tcp response","x":850,"y":360,"wires":[]},{"id":"e7a25533.761ed","type":"function","z":"7b8a611f.628c2","name":"parse readings","func":"var teststring;\nteststring  = \"protocol: v\"\nteststring += msg.version;\nteststring += \"\\nnode: \";\nteststring += msg.node;\nteststring += \"\\nfirmware: \";\nteststring += msg.firmware;\nteststring += \"\\nreport time: \";\nteststring += msg.timestamp;\nteststring += \"\\nnum measurements: \";\nteststring += msg.payload.measurements.length;\nfor (var i = 0; i < msg.payload.measurements.length; i++)\n{\n    if (i%10 == 9) teststring += \"~\";\n    teststring += \"\\n[\";\n    teststring += i;\n    teststring += \"@\";\n    teststring += msg.payload.measurements[i].timestamp - msg.payload.timestamp;\n    teststring += \"] (\";\n    teststring += msg.payload.measurements[i].type;\n    teststring += \"): \";\n    if (msg.payload.measurements[i].type === \"temperature\") {\n        teststring += msg.payload.measurements[i].value * 9/5 +32;\n    } else {\n        teststring += msg.payload.measurements[i].value;\n    }\n        \n    }\n\nmsg.payload = \"OK\";\n\nreturn [{ payload: teststring }, msg];","outputs":2,"noerr":0,"x":320,"y":60,"wires":[["68e18264.68dd6c"],["95ef3dcc.3f7598"]]},{"id":"b3c373aa.6fa49","type":"debug","z":"7b8a611f.628c2","name":"debug parser","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":640,"y":40,"wires":[]},{"id":"68e18264.68dd6c","type":"split","z":"7b8a611f.628c2","name":"","splt":"~","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":470,"y":40,"wires":[["b3c373aa.6fa49"]]},{"id":"96ec5b54.f3e4","type":"link out","z":"fb425031.4cd18","name":"handle sensor readings","links":["960d055.d13aa78"],"x":575,"y":360,"wires":[]},{"id":"1fa38d60.24dbd3","type":"function","z":"8e97fd4.b42f18","name":"transmit update","func":"var details = { payload : {} };\nvar response = \"\";\n\ndetails.payload.filename = msg.filename;\n//details.payload.content = msg.payload;\ndetails.payload.size = msg.payload.length;\ndetails.payload.md5 = msg.md5;\n\nresponse += msg.payload.length;\nresponse += \"\\n\";\nresponse += msg.md5;\nresponse += \"\\n\";\n\nvar msg_buf = Buffer.concat([Buffer.from(response), msg.payload], msg.payload.length + response.length);\nmsg.payload = msg_buf;\n\nreturn [details, msg];","outputs":2,"noerr":0,"x":640,"y":300,"wires":[["be88faa1.255b78"],["368cd58a.f195da"]]},{"id":"be88faa1.255b78","type":"debug","z":"8e97fd4.b42f18","name":"firmware details","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":820,"y":260,"wires":[]},{"id":"b7ec7007.a70f48","type":"md5","z":"8e97fd4.b42f18","name":"","fieldToHash":"payload","fieldTypeToHash":"msg","hashField":"md5","hashFieldType":"msg","x":570,"y":220,"wires":[["1fa38d60.24dbd3"]]},{"id":"368cd58a.f195da","type":"tcp out","z":"8e97fd4.b42f18","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"tcp response","x":730,"y":380,"wires":[]},{"id":"885960e3.60aad8","type":"function","z":"7b8a611f.628c2","name":"check update","func":"var update_needed = true;\n\nif (msg.firmware_dir.length === 0)\n    update_needed = false;\nelse\n    for (var i = 0; i < msg.firmware_dir.length; i++)\n    {\n        if (msg.firmware_dir[i].toLowerCase().search(msg.firmware.toLowerCase()) >= 0)\n            update_needed = false;\n    }\n\nif (update_needed) {\n    if (msg.payload.length > 0)\n        msg.payload += \",\";\n    msg.payload += \"update\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":260,"wires":[["518dfa0d.04c784","4e892c6a.4e9454"]]},{"id":"95ef3dcc.3f7598","type":"readdir","z":"7b8a611f.628c2","name":"firmware dir","dir":"firmware","as":"single","recursive":false,"outproperty":"firmware_dir","x":430,"y":160,"wires":[["885960e3.60aad8","d11d326.c7027d"]]},{"id":"d11d326.c7027d","type":"debug","z":"7b8a611f.628c2","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"firmware_dir","targetType":"msg","x":610,"y":120,"wires":[]},{"id":"7dcb104b.e3f668","type":"readdir","z":"8e97fd4.b42f18","name":"firmware_dir","dir":"firmware/","as":"single","recursive":false,"outproperty":"firmware_dir","x":310,"y":60,"wires":[["c054a5c6.afd4c8","29a13cd7.a828fc"]]},{"id":"6362a80a.76498","type":"function","z":"fb425031.4cd18","name":"parse header","func":"msg.version = msg.payload.version;\nmsg.timestamp = msg.payload.timestamp;\nmsg.node = msg.payload.node;\nmsg.firmware = msg.payload.firmware;\nreturn msg;","outputs":1,"noerr":0,"x":405,"y":254.99999237060547,"wires":[["cdc4e939.2808b8"]]},{"id":"29a13cd7.a828fc","type":"debug","z":"8e97fd4.b42f18","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"firmware_dir","targetType":"msg","x":510,"y":40,"wires":[]},{"id":"150c8c6b.10168c","type":"debug","z":"8e97fd4.b42f18","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"filename","targetType":"msg","x":560,"y":100,"wires":[]},{"id":"518dfa0d.04c784","type":"debug","z":"7b8a611f.628c2","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":710,"y":220,"wires":[]},{"id":"c0a6bc08.be80d8","type":"catch","z":"8e97fd4.b42f18","name":"error handler","scope":null,"uncaught":true,"x":270,"y":440,"wires":[["595d6d48.ca1fe4","76ce862a.024788"]]},{"id":"595d6d48.ca1fe4","type":"debug","z":"8e97fd4.b42f18","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"msg.error","targetType":"jsonata","x":430,"y":420,"wires":[]},{"id":"76ce862a.024788","type":"function","z":"8e97fd4.b42f18","name":"abort upload","func":"msg.payload = \"0\\n\";\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":480,"wires":[["3f689327.0c5bec"]]},{"id":"3e68e96f.5221f6","type":"catch","z":"8e97fd4.b42f18","name":"ignore tcp errors","scope":["1fa38d60.24dbd3"],"uncaught":false,"x":280,"y":340,"wires":[[]]},{"id":"4e892c6a.4e9454","type":"function","z":"7b8a611f.628c2","name":"null-terminate","func":"msg.payload += '\\0';\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":360,"wires":[["cb023030.4fbfb8"]]},{"id":"3f689327.0c5bec","type":"function","z":"8e97fd4.b42f18","name":"null-terminate","func":"msg.payload += '\\0';\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":560,"wires":[["368cd58a.f195da"]]}]